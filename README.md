# Финальный проект

## Маленькое отступление
Первоначальный план был (точнее создавался на ходу :)):
 * Поднимаем инфру с terraform
 * Заливаем туда все что надо с помощью ansible
 * С помощью ansible же, запускаем docker swarm.
 * Натягиваем это все на пайплайны
 * Уходим делать домашки по кубику, возвращаемся и допиливаем с кубиком вместо swarm

В процессе уже стало ясно что swarm к приемке я не успею, поэтому все переведено на docker-compose. Дальше план такой же:
 * дописать пайплайны с docker compose
 * уйти делать домашки и перевести все на кубер
PS Там еще была идея gitlab runners + docker machine, но нет... (см. CHANGELOG.md)

## CI/CD Pipeline
CI/CD построен на основе Gitlab Pipelines.

### Рабочий процесс
Главной идеей постройки этого CI/CD пайплайна является максимально автоматизированный процесс сборки и поставки и развертывания ПО. Процесс под который создается данный пайплан, выглядит следующим образом:
 * Создается задача
 * Разработчиком создается merge request с автоматически привязанной к задаче ветке.
 * Разработчик делает необходимые изменения и пушит их в репозитории
 * Gitlab Pipeline создает и тестирует образы сервисов, создает временную инфраструктуру (gitlab environments) и деплоит приложение на свеже созданные сервера.
 * При успешно пройденных тестах Merge Request может быть вмержен в master ветку.
 * После мержа в мастер, все этапы сборки запускаются заново для staging окружения.
 * После всех ручных (если необходимо) тестов, лид команды делает тэг вида `release-`, что вновь инициирует сборку всех пайплайнов, но для production окружения

### Этапы
 * build-prerequisites - создает базовый образ содержащий в себе необходимые инструменты для работы на всех последующих этапах пайплайна.
 * build - сборка базовых Docker образов сервисов crawler и ui
 * test - тестирование собранных образов
 * release - сборка релизных(готовых к использования) Docker образов на основе образов `build` этапа.
 * provision - создание инфраструктуры и провижинг необходимого ПО
 * deploy - деплой сервисов


## Инфраструктура
Инфраструктура построена на базе GCP. Вся инфраструктура поднимается с помощью Terraform workspaces, что позволяет создавать копии инфраструктур использую один TF backend. Все инстансы выделены в отдельную сеть.

Все инстансы (за исключением bastion, frontend хостов а так же DNS зон) - создаются с префиксом названия текущей ветки (terraform workspace).

Bastion хост (bastion terraform module) - доступ в сеть, может стучать во все инстансы, только к нему есть SSH доступ извне. Нужен для ansible

Frontend хост (frontend terraform module) - доступ в сеть по средство HTTP. Ansible устанавливает тут nginx, который проксирует все запросы на prod окружение. Запросы вида domain.com/dev/instance-name, проксируются на инстансы с FQDN `instance-name`. FQDN резолвятся с помощью GCP internal DNS. Используется для демонстрации работы а так же поддержки gitlab environments ~~(привет команде gitlab, можно же было сделать по динамической переменной URL!)~~

DNS zone (dns terraform module) - создает DNS зоны, рекорды.

## How to start
### Переменные окружения
 * `DOMAIN_NAME` - содержит доменное имя, требуется для модуля dns, nginx.
 * `GCP_INSTANCE_PRIVATE_KEY`, `GCP_INSTANCE_PUBLIC_KEY` - ключи для SSH доступа и проверки внутрь сети
 * `GOOGLE_APPLICATION_CREDENTIALS` - GCP service account file
 * `GOOGLE_PROJECT` - GCP название проекта
 * `GOOGLE_ZONE` - GCP зона (europe-west1-b etc)
 * `CI_REGISTRY_IMAGE`, `CI_COMMIT_REF_SLUG`, `CI_REGISTRY`, `CI_REGISTRY_USER`, `CI_REGISTRY_PASSWORD` - дефолтные переменные Gitlab Pipelines

### Makefile
Создан Makefile (да он не идеален, нужен рефакторинг, но лучше так :)), который используется в пайлайне. С его же помощью можно руками поднять инфру или повторить действия из пайлайна.

В общем, Makefile отвечает за 3 глобальных этапа: сборка сервисов, terraform, ansible.

#### Сборка сервисов
 * build-ui, build-crawler - отвечает за первую этап сборки (и пуша в регистр) на котором собираются базовые образы.
 * test-(ui,crawler) - тесты собранных образов
 * release-(ui, crawler) - конечная сборка и пуш в регистр образов

#### Terraform
 * infra-vars - создает vars.auto.tfvars исходя из переменных окружения
 * infra-initialization - запуск terraform init
 * infra-workspace - создает или выбирает ранее созданный workspace. Можно параметризировать: `TF_WORKSPACE_TO_SELECT=my-super-infra make infra-workspace`
 * infra-validation - валидация TF конфигурации
 * infra-planning(ужасные названия, знаю:)) - планирование и запись плана в tfplan файл
 * infra-applying - применение плана из файла tfplan
 * infra-destroy-planning - создание плана на уничтожение инфры

#### Ansible
 * gcloud-initialization - инициализация gcloud (надо чтобы забрать IP бастион хоста, т.к. он создается не для каждого воркспейса и не получается забрать через tf ouptus)
 * ssh-config - создает ssh.conf который используется ансиблом чтобы бегать через bastion
 * ansible-vars - создает vars.auto.yml в котором доп переменные для работы плейбуков
 * ansible-initialization - установка питон зависимостей, galaxy ролей и создание из темлейта inventory (привеt gcp_compute, который не умеет переменные)
 * provision-docker - запуск установки докера на все инстансы с тэгом docker
 * provision-full - запуск установки всего (nginx, docker)
 * deploy - деплой сервисов (черзе docker-compose :()

## Требования / TODO
 - [ ] Автоматизированные процессы создания и управления платформой
     * Ресурсы GCP
     * Инфраструктура для CI/CD
     * Инфраструктура для сбора обратной связи
 - [x] Использование практики IaC для управления конфигурацией и инфраструктурой
     - [x] Infra Provision - Terraform
     - [x] Software Provision - Ansible
 - [ ] Настроен процесс CI/CD
     - [x] App build
     - [ ] Infra Provision
         - [x] Terraform
         - [ ] Ansible
     - [ ] Deploy
         - [ ] ~~Swarm~~ docker-compose
         - [ ] Kubernetes
 - [ ] Все, что имеет отношение к проекту хранится в Git
 - [ ] Настроен процесс сбора обратной связи
     - [ ] Мониторинг
         - [ ] сбор метрик
         - [ ] алертинг
         - [ ] визуализация
     - [ ] Логирование (опционально)
     - [ ] Трейсинг (опционально)
     - [ ] ChatOps (опционально)
         - [ ] /run create-env my-env my-branch
         - [ ] /run destroy-env my-env
 - [ ] Документация
     - [ ] README по работе с репозиторием
         - [ ] Описание приложения и его архитектуры
         - [ ] CI/CD
             - [ ] Pipeline
                 - [x] Пример рабочего флоу
         - [ ] How to start?
             - [x] CI/CD Environment Variables
     - [ ] CHANGELOG с описанием выполненной работы
